steps:
  # Build the container image
  - name: 'gcr.io/cloud-builders/docker'
    args: 
      - 'build'
      - '--no-cache'
      - '-t'
      - 'gcr.io/$PROJECT_ID/react-app:latest'
      - '-t'
      - 'gcr.io/$PROJECT_ID/react-app:$SHORT_SHA'
      - '--build-arg'
      - 'REACT_APP_API_URL=https://focus-music-app-368754647823.us-central1.run.app'
      - '--build-arg'
      - 'REACT_APP_UNSPLASH_ACCESS_KEY=_GJARTSuiQMs3WhAexgyH7u_T2hKry5jOKzjL6xhLfE'
      - '--build-arg'
      - 'CACHE_BUST=$BUILD_ID'
      - '.'

  # Push both tags
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'gcr.io/$PROJECT_ID/react-app:latest']
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'gcr.io/$PROJECT_ID/react-app:$SHORT_SHA']

  # Deploy container image to Cloud Run with preserved environment variables
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "Starting deployment to Cloud Run..."
        if gcloud run deploy focus-music-app \
          --image=gcr.io/$PROJECT_ID/react-app:$SHORT_SHA \
          --region=us-central1 \
          --platform=managed \
          --allow-unauthenticated \
          --update-env-vars=NODE_ENV=production \
          --service-account=harry-gillen-builder@appspot.gserviceaccount.com; then
          echo "Deployment successful!"
          
          # Verify the deployment
          echo "Verifying deployment..."
          sleep 30  # Wait for the new version to be ready
          curl -s https://focus-music-app-368754647823.us-central1.run.app/api/health || echo "Health check failed"
        else
          echo "Deployment failed. Checking service account and permissions..."
          gcloud projects get-iam-policy $PROJECT_ID \
            --flatten="bindings[].members" \
            --filter="bindings.members:harry-gillen-builder@appspot.gserviceaccount.com"
          exit 1
        fi

  # Cleanup old images
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'gcloud'
    args:
      - 'container'
      - 'images'
      - 'list-tags'
      - 'gcr.io/$PROJECT_ID/react-app'
      - '--limit=5'
      - '--format=get(digest)'
      - '--sort-by=~timestamp'

options:
  logging: CLOUD_LOGGING_ONLY

images:
  - 'gcr.io/$PROJECT_ID/react-app:latest'
  - 'gcr.io/$PROJECT_ID/react-app:$SHORT_SHA'

serviceAccount: 'harry-gillen-builder@appspot.gserviceaccount.com'
timeout: '1200s'